---
layout: post
title: Load Testing Using Gatling
date: '2014-08-26T16:20:00.000+05:30'
author: Neil Ghosh
tags:
- Gatling
- Scala
- Load Test
- Code
- Functinal Programming
modified_time: '2014-10-26T01:03:39.986+05:30'
blogger_id: tag:blogger.com,1999:blog-6081677503074893817.post-4733994171511654789
blogger_orig_url: https://www.neilghosh.com/2014/08/load-testing-using-gatling.html
---

<div dir="ltr" style="text-align: left;" trbidi="on">Gatling is an open source load testing framework based on Scala programming language. One of the advantage of Gatling over other load testing framework that I have used is that the code is very elegant and readable, thanks to its own DSL. One may not have prior knowledge of Scala to get started with Gatling. There are some documentation in the <a href="http://gatling.io/docs/">Gatling website</a> which will help you write simple HTTP calls to your webservices but it gets bit difficult to incorporate the exact scenario of your test case because there are not much variety of example code which you can quickly edit and use. In this article I will try to show most of  the structural construct that are frequently used while making a series of dependent web-service calls, typically used by a mobile game client while interacting with the game server.<br /><br />Setup instructions are well described in the getting started tutorial. Following scala code will make a POST request to a mock REST endpoint that I have created using <a href="http://www.mockable.io/" target="_blank">mockable.io</a>.<br /><h3>Simple Request</h3><div style="background: #ffffff; border-width: .1em .1em .1em .8em; border: solid gray; overflow: auto; padding: .2em .6em; width: auto;"><br /><table><tbody><tr><td><br /><pre style="line-height: 125%; margin: 0;"> 1<br /> 2<br /> 3<br /> 4<br /> 5<br /> 6<br /> 7<br /> 8<br /> 9<br />10<br />11<br />12<br />13<br />14<br />15<br />16<br />17<br />18<br />19<br />20<br />21</pre><br /></td><td><br /><pre style="line-height: 125%; margin: 0;"><span style="color: #008800; font-weight: bold;">package</span> <span style="color: #0e84b5; font-weight: bold;">package1</span><br /><br /><span style="color: #008800; font-weight: bold;">import</span> <span style="color: #0e84b5; font-weight: bold;">io.gatling.core.Predef._</span><br /><span style="color: #008800; font-weight: bold;">import</span> <span style="color: #0e84b5; font-weight: bold;">io.gatling.http.Predef._</span><br /><span style="color: #008800; font-weight: bold;">import</span> <span style="color: #0e84b5; font-weight: bold;">scala.concurrent.duration._</span><br /><span style="color: #008800; font-weight: bold;">import</span> <span style="color: #0e84b5; font-weight: bold;">io.gatling.jsonpath._</span><br /><br /><span style="color: #008800; font-weight: bold;">class</span> <span style="color: #bb0066; font-weight: bold;">Test1</span> <span style="color: #008800; font-weight: bold;">extends</span> <span style="color: #bb0066; font-weight: bold;">Simulation</span> <span style="color: #333333;">{</span><br /><br />  <span style="color: #008800; font-weight: bold;">val</span> httpConf <span style="color: #008800; font-weight: bold;">=</span> http<br />    <span style="color: #333333;">.</span>baseURL<span style="color: #333333;">(</span><span style="background-color: #fff0f0;">"http://demo1263864.mockable.io/"</span><span style="color: #333333;">)</span> <br />    <span style="color: #333333;">.</span>acceptHeader<span style="color: #333333;">(</span><span style="background-color: #fff0f0;">"application/json"</span><span style="color: #333333;">)</span> <br /><br />  <span style="color: #008800; font-weight: bold;">val</span> scn <span style="color: #008800; font-weight: bold;">=</span> scenario<span style="color: #333333;">(</span><span style="background-color: #fff0f0;">"Simple scenario"</span><span style="color: #333333;">)</span><br />    <span style="color: #333333;">.</span>exec<span style="color: #333333;">(</span>http<span style="color: #333333;">(</span><span style="background-color: #fff0f0;">"First Request"</span><span style="color: #333333;">)</span><br />      <span style="color: #333333;">.</span>post<span style="color: #333333;">(</span><span style="background-color: #fff0f0;">"gatling"</span><span style="color: #333333;">)</span><br />      <span style="color: #333333;">.</span>body<span style="color: #333333;">(</span><span style="background-color: #fff0f0;">"""{"data":1}"""</span><span style="color: #333333;">)</span><br />      <span style="color: #333333;">.</span>headers<span style="color: #333333;">(</span>headers_1<span style="color: #333333;">).</span>check<span style="color: #333333;">(</span>jsonPath<span style="color: #333333;">(</span><span style="background-color: #fff0f0;">"$.result"</span><span style="color: #333333;">).</span>is<span style="color: #333333;">(</span><span style="background-color: #fff0f0;">"SUCCESS"</span><span style="color: #333333;">)))</span><br /><br />  setUp<span style="color: #333333;">(</span>scn<span style="color: #333333;">.</span>inject<span style="color: #333333;">(</span>atOnceUsers<span style="color: #333333;">(</span><span style="color: #0000dd; font-weight: bold;">1</span><span style="color: #333333;">)).</span>protocols<span style="color: #333333;">(</span>httpConf<span style="color: #333333;">))</span><br /><span style="color: #333333;">}</span></pre><br /></td></tr></tbody></table></div><br />Above code just sends following request<br /><blockquote>POST http://demo1263864.mockable.io/gatling</blockquote>with request body as<br /><blockquote><blockquote class="tr_bq">{"data":1}</blockquote></blockquote>I have kept the request body very simple as it does not have any effect. My REST services always responds with a fixed response, that is<br /><br /><div style="background: #ffffff; border-width: .1em .1em .1em .8em; border: solid gray; overflow: auto; padding: .2em .6em; width: auto;"><table><tbody><tr><td><br /><pre style="line-height: 125%; margin: 0;">1<br />2<br />3<br />4<br />5<br />6<br />7<br />8</pre><br /></td><td><br /><pre style="line-height: 125%; margin: 0;">{<br />  <span style="color: #007700;">"result"</span>: <span style="background-color: #fff0f0;">"SUCCESS"</span>,<br />  <span style="color: #007700;">"data"</span>: [<br />    {<br />      <span style="color: #007700;">"score"</span>: <span style="color: #0000dd; font-weight: bold;">200</span><br />    }<br />  ]<br />}</pre><br /></td></tr></tbody></table></div><br /><br />Note that jsonPath("$.result") fetches the top level JSON attributes and checks if it's value is "RESULT", otherwise it shows as one failure ("KO") in the final report. We could also check the HTTL status using .check(status.is(200))) . <a href="http://gatling.io/docs/2.0.0-RC2/http/http_check.html" target="_blank">More about check()</a>.<br /><br /><h3>Custom Headers and Body </h3><div style="background: #ffffff; border-width: .1em .1em .1em .8em; border: solid gray; overflow: auto; padding: .2em .6em; width: auto;"><table><tbody><tr><td><br /><pre style="line-height: 125%; margin: 0;">1</pre><br /></td><td><br /><pre style="line-height: 125%; margin: 0;">  <span style="color: #008800; font-weight: bold;">val</span> headers_1 <span style="color: #008800; font-weight: bold;">=</span> scala<span style="color: #333333;">.</span>collection<span style="color: #333333;">.</span>mutable<span style="color: #333333;">.</span><span style="color: #bb0066; font-weight: bold;">Map</span><span style="color: #333333;">(</span><span style="background-color: #fff0f0;">"Content-Type"</span> <span style="color: #333333;">-&gt;</span> <span style="background-color: #fff0f0;">"application/json"</span><span style="color: #333333;">)</span></pre><br /></td></tr></tbody></table></div><br />Notice that I have used a mutable map to initialize the header and later converted to a Map (immutable) because sometimes output of one requests might have to be input in the second request as part of request header or body. e.g.<br /><br /><div style="background: #ffffff; border-width: .1em .1em .1em .8em; border: solid gray; overflow: auto; padding: .2em .6em; width: auto;"><table><tbody><tr><td><br /><pre style="line-height: 125%; margin: 0;">1<br />2<br />3<br />4<br />5<br />6</pre><br /></td><td><br /><pre style="line-height: 125%; margin: 0;">  <span style="color: #008800; font-weight: bold;">val</span> scn <span style="color: #008800; font-weight: bold;">=</span> scenario<span style="color: #333333;">(</span><span style="background-color: #fff0f0;">"Simple scenario"</span><span style="color: #333333;">)</span><br />    <span style="color: #333333;">.</span>exec<span style="color: #333333;">(</span>http<span style="color: #333333;">(</span><span style="background-color: #fff0f0;">"First Request"</span><span style="color: #333333;">)</span><br />      <span style="color: #333333;">.</span>get<span style="color: #333333;">(</span><span style="background-color: #fff0f0;">"gatling"</span><span style="color: #333333;">).</span>headers<span style="color: #333333;">(</span>headers_1<span style="color: #333333;">.</span>toMap<span style="color: #333333;">)</span><br />      <span style="color: #333333;">.</span>check<span style="color: #333333;">(</span>jsonPath<span style="color: #333333;">(</span><span style="background-color: #fff0f0;">"$.result"</span><span style="color: #333333;">).</span>is<span style="color: #333333;">(</span><span style="background-color: #fff0f0;">"SUCCESS"</span><span style="color: #333333;">),</span> jsonPath<span style="color: #333333;">(</span><span style="background-color: #fff0f0;">"$.data[0].score"</span><span style="color: #333333;">).</span>saveAs<span style="color: #333333;">(</span><span style="background-color: #fff0f0;">"score"</span><span style="color: #333333;">)))</span><br />    <span style="color: #333333;">.</span>exec<span style="color: #333333;">(</span>http<span style="color: #333333;">(</span><span style="background-color: #fff0f0;">"Second Request"</span><span style="color: #333333;">).</span>post<span style="color: #333333;">(</span><span style="background-color: #fff0f0;">"gatling1"</span><span style="color: #333333;">).</span>headers<span style="color: #333333;">((</span>headers_1 <span style="color: #333333;">+=</span> <span style="background-color: #fff0f0;">"score"</span> <span style="color: #333333;">-&gt;</span> <span style="background-color: #fff0f0;">"${score}"</span><span style="color: #333333;">).</span>toMap<span style="color: #333333;">)</span><br />      <span style="color: #333333;">.</span>body<span style="color: #333333;">(</span><span style="color: #bb0066; font-weight: bold;">StringBody</span><span style="color: #333333;">(</span><span style="background-color: #fff0f0;">"""{"data":"${score}"}"""</span><span style="color: #333333;">)).</span>check<span style="color: #333333;">(</span>status<span style="color: #333333;">.</span>is<span style="color: #333333;">(</span><span style="color: #0000dd; font-weight: bold;">200</span><span style="color: #333333;">)))</span></pre><br /></td></tr></tbody></table></div><br /><br />In this case the attribute "score" is fetched from the output of the first request and then fed to the header and body of the second request. .saveAs("score") saves the value of score in the session with key "score" and makes it available to be fetched later. The session separate for all users that are injected by the setup(). So all user specific data which does not need to be shared across users should be saved in the session. "${score}" is an EL expression used for retrieving the value saved earlier in the session. <a href="http://gatling.io/docs/2.0.0-RC2/session/index.html" target="_blank">More about session</a>.<br /><br /><h3>Looping</h3>Let's say our output JSON array is as follows , which contains an array which we need to loop over.<br /><br /><div style="background: #ffffff; border-width: .1em .1em .1em .8em; border: solid gray; overflow: auto; padding: .2em .6em; width: auto;"><table><tbody><tr><td><br /><pre style="line-height: 125%; margin: 0;"> 1<br /> 2<br /> 3<br /> 4<br /> 5<br /> 6<br /> 7<br /> 8<br /> 9<br />10<br />11<br />12<br />13<br />14<br />15<br />16<br />17</pre><br /></td><td><br /><pre style="line-height: 125%; margin: 0;">{<br />  <span style="color: #007700;">"result"</span>: <span style="background-color: #fff0f0;">"SUCCESS"</span>,<br />  <span style="color: #007700;">"data"</span>: [<br />    {<br />      <span style="color: #007700;">"playerId"</span>: <span style="color: #0000dd; font-weight: bold;">1</span>,<br />      <span style="color: #007700;">"score"</span>: <span style="color: #0000dd; font-weight: bold;">200</span><br />    },<br />    {<br />      <span style="color: #007700;">"playerId"</span>: <span style="color: #0000dd; font-weight: bold;">2</span>,<br />      <span style="color: #007700;">"score"</span>: <span style="color: #0000dd; font-weight: bold;">300</span><br />    },<br />    {<br />      <span style="color: #007700;">"playerId"</span>: <span style="color: #0000dd; font-weight: bold;">3</span>,<br />      <span style="color: #007700;">"score"</span>: <span style="color: #0000dd; font-weight: bold;">400</span><br />    }<br />  ]<br />}</pre><br /></td></tr></tbody></table></div><br />Our code to consume it and iterate over all the player/score entry would be<br /><br /><div style="background: #ffffff; border-width: .1em .1em .1em .8em; border: solid gray; overflow: auto; padding: .2em .6em; width: auto;"><table><tbody><tr><td><br /><pre style="line-height: 125%; margin: 0;"> 1<br /> 2<br /> 3<br /> 4<br /> 5<br /> 6<br /> 7<br /> 8<br /> 9<br />10<br />11<br />12</pre><br /></td><td><br /><pre style="line-height: 125%; margin: 0;">  <span style="color: #008800; font-weight: bold;">val</span> scn <span style="color: #008800; font-weight: bold;">=</span> scenario<span style="color: #333333;">(</span><span style="background-color: #fff0f0;">"Simple scenario"</span><span style="color: #333333;">)</span><br />    <span style="color: #333333;">.</span>exec<span style="color: #333333;">(</span>http<span style="color: #333333;">(</span><span style="background-color: #fff0f0;">"First Request"</span><span style="color: #333333;">)</span><br />      <span style="color: #333333;">.</span>get<span style="color: #333333;">(</span><span style="background-color: #fff0f0;">"gatling"</span><span style="color: #333333;">)</span><br />      <span style="color: #333333;">.</span>headers<span style="color: #333333;">(</span>headers_1<span style="color: #333333;">.</span>toMap<span style="color: #333333;">)</span><br />      <span style="color: #333333;">.</span>check<span style="color: #333333;">(</span>jsonPath<span style="color: #333333;">(</span><span style="background-color: #fff0f0;">"$.result"</span><span style="color: #333333;">).</span>is<span style="color: #333333;">(</span><span style="background-color: #fff0f0;">"SUCCESS"</span><span style="color: #333333;">),</span> jsonPath<span style="color: #333333;">(</span><span style="background-color: #fff0f0;">"$.data[*]"</span><span style="color: #333333;">).</span>ofType<span style="color: #333333;">[</span><span style="color: #333399; font-weight: bold;">Map</span><span style="color: #333333;">[</span><span style="color: #333399; font-weight: bold;">String</span>, <span style="color: #333399; font-weight: bold;">Any</span><span style="color: #333333;">]].</span>findAll<span style="color: #333333;">.</span>saveAs<span style="color: #333333;">(</span><span style="background-color: #fff0f0;">"pList"</span><span style="color: #333333;">)))</span><br />    <span style="color: #333333;">.</span>foreach<span style="color: #333333;">(</span><span style="background-color: #fff0f0;">"${pList}"</span><span style="color: #333333;">,</span> <span style="background-color: #fff0f0;">"player"</span><span style="color: #333333;">)</span> <span style="color: #333333;">{</span><br />      exec<span style="color: #333333;">(</span>session <span style="color: #008800; font-weight: bold;">=&gt;</span> <span style="color: #333333;">{</span><br />        <span style="color: #008800; font-weight: bold;">val</span> playerMap <span style="color: #008800; font-weight: bold;">=</span> session<span style="color: #333333;">(</span><span style="background-color: #fff0f0;">"player"</span><span style="color: #333333;">).</span>as<span style="color: #333333;">[</span><span style="color: #333399; font-weight: bold;">Map</span><span style="color: #333333;">[</span><span style="color: #333399; font-weight: bold;">String</span>, <span style="color: #333399; font-weight: bold;">Any</span><span style="color: #333333;">]]</span><br />        <span style="color: #008800; font-weight: bold;">val</span> playerId <span style="color: #008800; font-weight: bold;">=</span> playerMap<span style="color: #333333;">(</span><span style="background-color: #fff0f0;">"playerId"</span><span style="color: #333333;">)</span><br />        session<span style="color: #333333;">.</span>set<span style="color: #333333;">(</span><span style="background-color: #fff0f0;">"playerId"</span><span style="color: #333333;">,</span> playerId<span style="color: #333333;">)</span><br />      <span style="color: #333333;">})</span><br />    <span style="color: #333333;">}</span></pre><br /></td></tr></tbody></table></div><br /><br />In above code snippet we are looping over a JSON array which output of the earlier request. pList stores the all the entries in the JSON array temporarily in the session and then .foreach block loops over it feeding one at a time with the session key "player". In this loop at the end we save the required value with session.set method. Since session is immutable all the session manipulation code wrapped around a session function as above.<br /><br />Notice that "$.data[*]" is jsonPath expression to get hold of all the elements of the array attribute "data". <a href="https://github.com/gatling/jsonpath" target="_blank">More about jsonPath expressions.</a><span style="background-color: #fff0f0;"><br /></span><br /><br />We can also use a counter to loop over a list and fetch corresponding element from another list when more than one list is saved in the session. This is useful when the JSON structure is nested. Refer the following JSON structure.<br /><br /><div style="background: #ffffff; border-width: .1em .1em .1em .8em; border: solid gray; overflow: auto; padding: .2em .6em; width: auto;"><table><tbody><tr><td><br /><pre style="line-height: 125%; margin: 0;"> 1<br /> 2<br /> 3<br /> 4<br /> 5<br /> 6<br /> 7<br /> 8<br /> 9<br />10<br />11<br />12</pre><br /></td><td><br /><pre style="line-height: 125%; margin: 0;">{<br />  <span style="color: #007700;">"result"</span>: <span style="background-color: #fff0f0;">"SUCCESS"</span>,<br />  <span style="color: #007700;">"data"</span>: [<br />    {<br />      <span style="color: #007700;">"playerId"</span>: {<br />        <span style="color: #007700;">"id"</span>: <span style="color: #0000dd; font-weight: bold;">2</span>,<br />        <span style="color: #007700;">"version"</span>: <span style="color: #0000dd; font-weight: bold;">1</span><br />      },<br />      <span style="color: #007700;">"score"</span>: <span style="color: #0000dd; font-weight: bold;">200</span><br />    }<br />  ]<br />}</pre><br /></td></tr></tbody></table></div><br /><!-- HTML generated using hilite.me --><br /><div style="background: #ffffff; border-width: .1em .1em .1em .8em; border: solid gray; overflow: auto; padding: .2em .6em; width: auto;"><table><tbody><tr><td><br /><pre style="line-height: 125%; margin: 0;"> 1<br /> 2<br /> 3<br /> 4<br /> 5<br /> 6<br /> 7<br /> 8<br /> 9<br />10<br />11<br />12<br />13<br />14<br />15<br />16<br />17</pre><br /></td><td><br /><pre style="line-height: 125%; margin: 0;">  <span style="color: #008800; font-weight: bold;">val</span> scn <span style="color: #008800; font-weight: bold;">=</span> scenario<span style="color: #333333;">(</span><span style="background-color: #fff0f0;">"Simple scenario"</span><span style="color: #333333;">)</span><br />    <span style="color: #333333;">.</span>exec<span style="color: #333333;">(</span>http<span style="color: #333333;">(</span><span style="background-color: #fff0f0;">"First Request"</span><span style="color: #333333;">)</span><br />      <span style="color: #333333;">.</span>get<span style="color: #333333;">(</span><span style="background-color: #fff0f0;">"gatling"</span><span style="color: #333333;">)</span><br />      <span style="color: #333333;">.</span>headers<span style="color: #333333;">(</span>headers_1<span style="color: #333333;">.</span>toMap<span style="color: #333333;">)</span><br />      <span style="color: #333333;">.</span>check<span style="color: #333333;">(</span>jsonPath<span style="color: #333333;">(</span><span style="background-color: #fff0f0;">"$.result"</span><span style="color: #333333;">).</span>is<span style="color: #333333;">(</span><span style="background-color: #fff0f0;">"SUCCESS"</span><span style="color: #333333;">),</span><br />        jsonPath<span style="color: #333333;">(</span><span style="background-color: #fff0f0;">"$.data[*].playerId.id"</span><span style="color: #333333;">).</span>findAll<span style="color: #333333;">.</span>dontValidate<span style="color: #333333;">.</span>saveAs<span style="color: #333333;">(</span><span style="background-color: #fff0f0;">"ids"</span><span style="color: #333333;">),</span> jsonPath<span style="color: #333333;">(</span><span style="background-color: #fff0f0;">"$.data[*].playerId.version"</span><span style="color: #333333;">).</span>findAll<span style="color: #333333;">.</span>dontValidate<span style="color: #333333;">.</span>saveAs<span style="color: #333333;">(</span><span style="background-color: #fff0f0;">"versions"</span><span style="color: #333333;">)))</span><br />    <span style="color: #333333;">.</span>exec<span style="color: #333333;">(</span>session <span style="color: #008800; font-weight: bold;">=&gt;</span> <span style="color: #333333;">{</span><br />      <span style="color: #008800; font-weight: bold;">val</span> ids <span style="color: #008800; font-weight: bold;">=</span> session<span style="color: #333333;">(</span><span style="background-color: #fff0f0;">"ids"</span><span style="color: #333333;">).</span>as<span style="color: #333333;">[</span><span style="color: #333399; font-weight: bold;">Vector</span><span style="color: #333333;">[</span><span style="color: #333399; font-weight: bold;">String</span><span style="color: #333333;">]]</span><br />      <span style="color: #008800; font-weight: bold;">val</span> versions <span style="color: #008800; font-weight: bold;">=</span> session<span style="color: #333333;">(</span><span style="background-color: #fff0f0;">"versions"</span><span style="color: #333333;">).</span>as<span style="color: #333333;">[</span><span style="color: #333399; font-weight: bold;">Vector</span><span style="color: #333333;">[</span><span style="color: #333399; font-weight: bold;">String</span><span style="color: #333333;">]]</span><br />      <span style="color: #008800; font-weight: bold;">val</span> validIds <span style="color: #008800; font-weight: bold;">=</span> <span style="color: #008800; font-weight: bold;">new</span> <span style="color: #bb0066; font-weight: bold;">ListBuffer</span><span style="color: #333333;">[</span><span style="color: #333399; font-weight: bold;">String</span><span style="color: #333333;">]()</span><br />      ids<span style="color: #333333;">.</span>indices<span style="color: #333333;">.</span>foreach <span style="color: #333333;">{</span> i <span style="color: #008800; font-weight: bold;">=&gt;</span><br />        <span style="color: #008800; font-weight: bold;">if</span> <span style="color: #333333;">(</span>versions<span style="color: #333333;">(</span>i<span style="color: #333333;">)</span> <span style="color: #333333;">==</span> <span style="background-color: #fff0f0;">"0"</span><span style="color: #333333;">)</span> <span style="color: #333333;">{</span><br />          validIds <span style="color: #333333;">+=</span> opptetrisIds<span style="color: #333333;">(</span>i<span style="color: #333333;">)</span><br />        <span style="color: #333333;">}</span><br />      <span style="color: #333333;">}</span><br />      session<span style="color: #333333;">.</span>set<span style="color: #333333;">(</span><span style="background-color: #fff0f0;">"validIds"</span><span style="color: #333333;">,</span> validIds<span style="color: #333333;">.</span>toList<span style="color: #333333;">)</span><br />    <span style="color: #333333;">})</span></pre><br /></td></tr></tbody></table></div><br />In above code we save both the Ids and corresponding versions in separate list and then loop over the ids. We create a new list of IDs for which the corresponding version is 0. Finally we save the filtered Ids for further processing.<br /><br /><h3>Flow branching</h3><div style="background: #ffffff; border-width: .1em .1em .1em .8em; border: solid gray; overflow: auto; padding: .2em .6em; width: auto;"><table><tbody><tr><td><br /><pre style="line-height: 125%; margin: 0;"> 1<br /> 2<br /> 3<br /> 4<br /> 5<br /> 6<br /> 7<br /> 8<br /> 9<br />10<br />11<br />12<br />13<br />14<br />15<br />16<br />17<br />18<br />19<br />20<br />21<br />22<br />23<br />24<br />25<br />26<br />27<br />28<br />29<br />30<br />31<br />32<br />33<br />34</pre><br /></td><td><br /><pre style="line-height: 125%; margin: 0;">  <span style="color: #888888;">//Global Users</span><br />  <span style="color: #008800; font-weight: bold;">val</span> userMap <span style="color: #008800; font-weight: bold;">=</span> scala<span style="color: #333333;">.</span>collection<span style="color: #333333;">.</span>concurrent<span style="color: #333333;">.</span><span style="color: #bb0066; font-weight: bold;">TrieMap</span><span style="color: #333333;">[</span><span style="color: #333399; font-weight: bold;">String</span>, <span style="color: #333399; font-weight: bold;">String</span><span style="color: #333333;">]()</span><br />  <span style="color: #888888;">//Randomiser </span><br />  <span style="color: #008800; font-weight: bold;">val</span> rnd <span style="color: #008800; font-weight: bold;">=</span> <span style="color: #008800; font-weight: bold;">new</span> scala<span style="color: #333333;">.</span>util<span style="color: #333333;">.</span><span style="color: #bb0066; font-weight: bold;">Random</span><br /><br /><br />  <span style="color: #008800; font-weight: bold;">val</span> headers_1 <span style="color: #008800; font-weight: bold;">=</span> scala<span style="color: #333333;">.</span>collection<span style="color: #333333;">.</span>mutable<span style="color: #333333;">.</span><span style="color: #bb0066; font-weight: bold;">Map</span><span style="color: #333333;">(</span><span style="background-color: #fff0f0;">"Content-Type"</span> <span style="color: #333333;">-&gt;</span> <span style="background-color: #fff0f0;">"application/json"</span><span style="color: #333333;">)</span><br /><br />  <span style="color: #008800; font-weight: bold;">val</span> scn <span style="color: #008800; font-weight: bold;">=</span> scenario<span style="color: #333333;">(</span><span style="background-color: #fff0f0;">"Simple scenario"</span><span style="color: #333333;">)</span><br />  exec<span style="color: #333333;">(</span>session <span style="color: #008800; font-weight: bold;">=&gt;</span> <span style="color: #333333;">{</span><br />    <span style="color: #008800; font-weight: bold;">var</span> newUser <span style="color: #008800; font-weight: bold;">=</span> <span style="color: #333333;">(</span>rnd<span style="color: #333333;">.</span>nextInt<span style="color: #333333;">(</span><span style="color: #0000dd; font-weight: bold;">10</span><span style="color: #333333;">)</span> <span style="color: #333333;">&gt;</span> <span style="color: #0000dd; font-weight: bold;">8</span> <span style="color: #333333;">||</span> userMap<span style="color: #333333;">.</span>size <span style="color: #333333;">&lt;</span> <span style="color: #0000dd; font-weight: bold;">1</span><span style="color: #333333;">)</span><br />    session<span style="color: #333333;">.</span>set<span style="color: #333333;">(</span><span style="background-color: #fff0f0;">"newUser"</span><span style="color: #333333;">,</span> newUser<span style="color: #333333;">)</span><br />  <span style="color: #333333;">})</span><br />    <span style="color: #333333;">.</span>doIfOrElse<span style="color: #333333;">(</span>session <span style="color: #008800; font-weight: bold;">=&gt;</span> session<span style="color: #333333;">(</span><span style="background-color: #fff0f0;">"newUser"</span><span style="color: #333333;">).</span>as<span style="color: #333333;">[</span><span style="color: #333399; font-weight: bold;">Boolean</span><span style="color: #333333;">])</span> <span style="color: #333333;">{</span><br />      exec<span style="color: #333333;">(</span><br />        http<span style="color: #333333;">(</span><span style="background-color: #fff0f0;">"If request"</span><span style="color: #333333;">)</span><br />          <span style="color: #333333;">.</span>post<span style="color: #333333;">(</span><span style="background-color: #fff0f0;">"gatling"</span><span style="color: #333333;">)</span><br />          <span style="color: #333333;">.</span>headers<span style="color: #333333;">(</span>headers_1<span style="color: #333333;">.</span>toMap<span style="color: #333333;">)</span><br />          <span style="color: #333333;">.</span>body<span style="color: #333333;">(</span><span style="color: #bb0066; font-weight: bold;">StringBody</span><span style="color: #333333;">(</span><span style="background-color: #fff0f0;">"""{}"""</span><span style="color: #333333;">)).</span>asJSON<br />          <span style="color: #333333;">.</span>check<span style="color: #333333;">(</span>status<span style="color: #333333;">.</span>is<span style="color: #333333;">(</span><span style="color: #0000dd; font-weight: bold;">200</span><span style="color: #333333;">)))</span><br />    <span style="color: #333333;">}</span> <span style="color: #333333;">{</span><br />      exec<span style="color: #333333;">(</span>session <span style="color: #008800; font-weight: bold;">=&gt;</span> <span style="color: #333333;">{</span><br />        <span style="color: #008800; font-weight: bold;">val</span> index <span style="color: #008800; font-weight: bold;">=</span> rnd<span style="color: #333333;">.</span>nextInt<span style="color: #333333;">(</span>userMap<span style="color: #333333;">.</span>size<span style="color: #333333;">)</span><br />        <span style="color: #008800; font-weight: bold;">val</span> userArray <span style="color: #008800; font-weight: bold;">=</span> userMap<span style="color: #333333;">.</span>toArray<span style="color: #333333;">.</span>map<span style="color: #333333;">(</span>x <span style="color: #008800; font-weight: bold;">=&gt;</span> <span style="color: #bb0066; font-weight: bold;">Array</span><span style="color: #333333;">(</span>x<span style="color: #333333;">.</span>_1<span style="color: #333333;">,</span> x<span style="color: #333333;">.</span>_2<span style="color: #333333;">))</span><br /><br />        session<span style="color: #333333;">.</span>set<span style="color: #333333;">(</span><span style="background-color: #fff0f0;">"id"</span><span style="color: #333333;">,</span> userArray<span style="color: #333333;">(</span>index<span style="color: #333333;">)(</span><span style="color: #0000dd; font-weight: bold;">0</span><span style="color: #333333;">))</span><br />          <span style="color: #333333;">.</span>set<span style="color: #333333;">(</span><span style="background-color: #fff0f0;">"version"</span><span style="color: #333333;">,</span> userArray<span style="color: #333333;">(</span>index<span style="color: #333333;">)(</span><span style="color: #0000dd; font-weight: bold;">1</span><span style="color: #333333;">))</span><br />      <span style="color: #333333;">})</span><br />        <span style="color: #333333;">.</span>exec<span style="color: #333333;">(</span>http<span style="color: #333333;">(</span><span style="background-color: #fff0f0;">"Else Users"</span><span style="color: #333333;">)</span><br />          <span style="color: #333333;">.</span>post<span style="color: #333333;">(</span><span style="background-color: #fff0f0;">"gatling"</span><span style="color: #333333;">)</span><br />          <span style="color: #333333;">.</span>headers<span style="color: #333333;">(</span>headers_1<span style="color: #333333;">.</span>toMap<span style="color: #333333;">)</span><br />          <span style="color: #333333;">.</span>body<span style="color: #333333;">(</span><span style="color: #bb0066; font-weight: bold;">StringBody</span><span style="color: #333333;">(</span><span style="background-color: #fff0f0;">"""{"id":"${id}, "version":"${version}"}"""</span><span style="color: #333333;">)).</span>asJSON<br />          <span style="color: #333333;">)</span><br />    <span style="color: #333333;">}</span></pre><br /></td></tr></tbody></table><br /></div><br /><br />In the above code we maintain a global map. Let's assume we need a pool users who will be making requests to the server and we also need the user to be an existing user sometimes and a brand new users otherwise. Say 2 in 10 users should be new and rest should be taken from the existing pool. We maintain a global userMap where we store all the newly created users and we refer the same map to fetch existing users. The global map is visible to all the threads so its not specific to any session.<br /><br />Finally the load test plan is the most important part of the whole activity where you should be able to control the arrival of the users. e.g. if you want 10 users to arrive in uniform rate over the span of 30 seconds following should be your injection code.<br /><br /><div style="background: #ffffff; border-width: .1em .1em .1em .8em; border: solid gray; overflow: auto; padding: .2em .6em; width: auto;"><table><tbody><tr><td><br /><pre style="line-height: 125%; margin: 0;">1<br />2</pre><br /></td><td><br /><pre style="line-height: 125%; margin: 0;">  setUp<span style="color: #333333;">(</span><br />    scn<span style="color: #333333;">.</span>inject<span style="color: #333333;">(</span>rampUsers<span style="color: #333333;">(</span><span style="color: #0000dd; font-weight: bold;">10</span><span style="color: #333333;">)</span> over <span style="color: #333333;">(</span><span style="color: #0000dd; font-weight: bold;">30</span> seconds<span style="color: #333333;">)).</span>protocols<span style="color: #333333;">(</span>httpConf<span style="color: #333333;">)))</span></pre><br /></td></tr></tbody></table></div><br />There are several other ways to create the desired pattern in <a href="http://gatling.io/docs/2.0.0-RC2/general/simulation_setup.html" target="_blank">this tutorial</a>.<br /><h3>References<br /> </h3><ul><li>Code Beautifier - <a href="http://hilite.me/">hilite.me</a></li><br /><li>Gatling 1.5 to 2.0 migration <a href="https://github.com/gatling/gatling/blob/master/src/sphinx/index.rst">documentation </a></li><br /><li>Gatling 2.0 <a href="http://gatling.io/docs/2.0.0-RC2/index.html">documentation</a>.</li><br /><li>Gatling 1.5.6 <a href="http://gatling.io/docs/1.5.6/index.html">documentation </a></li><br /><li><a href="https://groups.google.com/forum/#!forum/gatling">Gatling User Group</a></li><br /><li>Gatling <a href="http://stackoverflow.com/questions/tagged/gatling">Stackoverflow </a></li></ul></div>