---
layout: post
title: Appengine.Maven.Guice.Sitebricks.Objectify
date: '2013-06-20T18:10:00.000+05:30'
author: Neil Ghosh
tags:
- Appengine
- Google
- webservices
- Maven
- Guice
- Code
- Sitebricks
- java
- Objectify
modified_time: '2014-10-11T20:22:38.354+05:30'
blogger_id: tag:blogger.com,1999:blog-6081677503074893817.post-1738357315981643464
blogger_orig_url: https://www.neilghosh.com/2013/06/appenginemavenguicesitebricksobjectify.html
---

I have been trying to read and use all these technology for my project but I did not find any single article/blog which includes setup instructions for all of them.<br/><br/>Most of these technologies are from Google and optimizes for their PaaS solution.<br/><ul><br/>	<li><a href="https://appengine.google.com/" target="_blank">Google AppEngine</a> - The platform as a service supporting several languages including  Python, Java.</li><br/>	<li><a href="https://developers.google.com/appengine/docs/java/tools/maven" target="_blank">Maven</a>  - Build tool like ant but lets you pull the libraries from the original repository dynamically at the build time.</li><br/>	<li><a href="http://code.google.com/p/google-guice/" target="_blank">Guice</a> - Dependency Injection tool like spring without XML configuration. Configuration is done in code itself.</li><br/>	<li><a href="http://code.google.com/p/google-sitebricks/" target="_blank">Sitebricks</a> -  Libraries for creating REST webservices and dynamic HTML page (separating HTML and Data ).</li><br/>	<li><a href="http://code.google.com/p/objectify-appengine/" target="_blank">Objectify</a> - Library to interact with Google AppEngine datastore and automatic memcached management.</li><br/></ul><br/>Following are the major steps I took for creating a working project.<br/><ol><br/>	<li>Since I was trying to create a web app with maven I needed to create the folder structure for web project containing WEB-INF etc. I could do this manually too. <a href="http://www.mkyong.com/maven/how-to-create-a-web-application-project-with-maven/" target="_blank">Details</a> .<br/><blockquote>$ mvn archetype:generate -DgroupId=com.neil -DartifactId=NoteWebApp -DarchetypeArtifactId=maven-archetype-webapp -DinteractiveMode=false</blockquote><br/></li><br/>	<li>Added the Google appengine dependency in the <a href="https://github.com/neilghosh/cross-note/blob/ebf9b8c154d4927f5f0efcb4b648c3effbc1f457/pom.xml" target="_blank">POM.xml</a> in the recently created Maven project.<br/>[code language="xml"]<br/>&lt;dependency&gt;<br/>&lt;groupId&gt;com.google.appengine&lt;/groupId&gt;<br/>&lt;artifactId&gt;appengine-api-1.0-sdk&lt;/artifactId&gt;<br/>&lt;version&gt;1.8.1&lt;/version&gt;<br/>&lt;/dependency&gt;<br/>[/code]</li><br/>	<li>Add Google app engine plugin for the maven tools to be used for running devserver and uploading the build to appengine cloud.<br/>Here we could also mention the debug port which any idea can connect.<br/><ul><br/>	<li>Local server can be started using "mvn appengine:devserver". <a href="https://developers.google.com/appengine/docs/java/tools/maven#Using_The_App_Engine_Maven_Plugin" target="_blank">Details</a>.</li><br/>	<li>Local app can be deployed in appengine server at "mvn appengine:update"</li><br/></ul><br/>Sometimes "port in use" error occurs if previous debug port or server port is not closed gracefully then we have to query for the process using the port and kill it.<br/><blockquote>sudo lsof -i :8080 # checks port 8080 in mac<br/>kill -9 2828</blockquote><br/>[code language="xml"]<br/>  &lt;plugins&gt;<br/>   &lt;plugin&gt;<br/>    &lt;groupId&gt;com.google.appengine&lt;/groupId&gt;<br/>    &lt;artifactId&gt;appengine-maven-plugin&lt;/artifactId&gt;<br/>    &lt;version&gt;1.8.1&lt;/version&gt;<br/>    &lt;configuration&gt;<br/>        &lt;!--<br/>        &lt;jvmFlags&gt;<br/>            &lt;jvmFlag&gt;-Xdebug&lt;/jvmFlag&gt;<br/>            &lt;jvmFlag&gt;-agentlib:jdwp=transport=dt_socket,address=5000,server=y,suspend=n&lt;/jvmFlag&gt;<br/>        &lt;/jvmFlags&gt;<br/>        --&gt;<br/>    &lt;/configuration&gt;<br/>   &lt;/plugin&gt;<br/>  &lt;/plugins&gt;<br/><br/>[/code]</li><br/>	<li>Add the appengine-web.xml in the same directory as web.xml which will hold the appengine configuration.<br/>[code language="xml"]<br/>&lt;appengine-web-app xmlns=&quot;http://appengine.google.com/ns/1.0&quot;&gt;<br/>&lt;!-- create this unique id in appengine console in web--&gt;<br/>&lt;application&gt;testjavaneil&lt;/application&gt;<br/>&lt;!-- I only keep only one version during dev and keep overwriting it. --&gt;<br/>&lt;version&gt;1&lt;/version&gt;<br/>&lt;!-- I have no idea about it --&gt;<br/>&lt;threadsafe&gt;true&lt;/threadsafe&gt;<br/>&lt;/appengine-web-app&gt;<br/>[/code]</li><br/>	<li>Add dependency for Guice<br/>[code language="xml"]<br/>    &lt;dependency&gt;<br/>      &lt;groupId&gt;com.google.inject&lt;/groupId&gt;<br/>      &lt;artifactId&gt;guice&lt;/artifactId&gt;<br/>      &lt;version&gt;3.0&lt;/version&gt;<br/>    &lt;/dependency&gt;<br/>[/code]</li><br/>	<li>Add a listener servlet in web.xml which will get executed when container comes up. Also add a filter which will redirect all the urls to the Guice filter<br/>which in turn will have the information which class to be executed depending on the request URL.This configuration will be done in the listener.<br/>[code language="xml"]<br/>    &lt;filter&gt;<br/>        &lt;filter-name&gt;webFilter&lt;/filter-name&gt;<br/>        &lt;filter-class&gt;com.google.inject.servlet.GuiceFilter&lt;/filter-class&gt;<br/>    &lt;/filter&gt;<br/><br/>    &lt;filter-mapping&gt;<br/>        &lt;filter-name&gt;webFilter&lt;/filter-name&gt;<br/>        &lt;url-pattern&gt;/*&lt;/url-pattern&gt;<br/>    &lt;/filter-mapping&gt;<br/><br/>    &lt;listener&gt;<br/>        &lt;listener-class&gt;com.neil.MyGuiceServletConfig&lt;/listener-class&gt;<br/>    &lt;/listener&gt;<br/>[/code]</li><br/>	<li>As promised in the last step I will create the listener with the information of url mappings<br/>[code language="java"]<br/>public class MyGuiceServletConfig extends GuiceServletContextListener {<br/><br/>    @Override<br/>    protected Injector getInjector() {<br/>        return Guice.createInjector(<br/>                //Keep sending Guice the modules<br/>                new SitebricksModule() {<br/>                    @Override<br/>                    protected void configureSitebricks() {<br/>                        scan(NotebookService.class.getPackage());<br/>                        //Should change this to logger, this is just to proove that<br/>                        //sitebrick scans the classes for annotations like @At etc.<br/>                        System.out.println(&quot;****** Scan complete ******&quot;);<br/>                    }<br/>                }<br/>                , new ServletModule() {<br/>                    @Override<br/>                    protected void configureServlets() {<br/>                        //Servlet classes have to be singleton to be consistent with servlet specification<br/>                        //In tranditional cases web.xml config tell the container to do so I guess.<br/>                        bind(com.neil.NotebookServlet.class).in(Singleton.class);<br/>                        //Analogous to typcial servlet URL mappings<br/>                        serve(&quot;/servlet&quot;).with(com.neil.NotebookServlet.class);<br/>                    }<br/>                }<br/>        );<br/>    }<br/>}<br/><br/>[/code]</li><br/>	<li>Following is a typical servlet class but will will avoid this and use templates and webservices to render data in HTML or JSON format.<br/>[code language="java"]<br/><br/>public class NotebookServlet extends HttpServlet {<br/><br/>    //Register the entity class for data persistance  service<br/>    static {<br/>        ObjectifyService.register(Note.class);<br/>    }<br/><br/>    /**<br/>     * Get requests come here<br/>     *<br/>     * @param req<br/>     * @param resp<br/>     * @throws ServletException<br/>     * @throws IOException<br/>     */<br/>    @Override<br/>    public void doGet(<br/>            HttpServletRequest req, HttpServletResponse resp)<br/>            throws ServletException, IOException {<br/>        resp.setContentType(&quot;text/html&quot;);<br/>        //Render the form for adding notes<br/>        resp.getWriter().println(<br/>                &quot;&lt;form method=post  action=&quot;/servlet&quot; &gt;&quot; +<br/>                        &quot;&lt;input name=&quot;note.text&quot; size=&quot;20&quot; type=text/&gt;&quot; +<br/>                        &quot;&lt;input type=submit value=&quot;Add Note&quot;&gt;&quot; +<br/>                        &quot;&lt;/form&gt;&quot;);<br/><br/>        resp.getWriter().println(&quot;List of notes&quot;);<br/><br/>        //load all the data from datastore<br/>        List&lt;Note&gt; notes = ObjectifyService.ofy().load().type(Note.class).list();<br/>        //Render the notes in each row of the table.<br/>        resp.getWriter().println(&quot;&lt;table&gt;&lt;tr style=&quot;background:grey&quot;&gt;&lt;th&gt;Date&lt;/th&gt;&lt;th&gt;Note&lt;/th&gt;&lt;/tr&gt;&quot;);<br/>        for (Note noteEntry : notes) {<br/>            resp.getWriter().println(&quot;&lt;tr&gt;&quot;);<br/>            resp.getWriter().println(&quot;&lt;td&gt;&quot; + noteEntry.getDate().toString() + &quot;&lt;/td&gt;&lt;td&gt;&quot; + noteEntry.getText() + &quot;&lt;/td&gt;&quot;);<br/>            resp.getWriter().println(&quot;&lt;/tr&gt;&quot;);<br/>        }<br/>        resp.getWriter().println(&quot;&lt;table&gt;&quot;);<br/>    }<br/><br/>    /**<br/>     * Handles the form submit post requests and redirect to the same get request to display the list of<br/>     * notes<br/>     * @param req<br/>     * @param resp<br/>     * @throws ServletException<br/>     * @throws IOException<br/>     */<br/>    @Override<br/>    public void doPost(HttpServletRequest req, HttpServletResponse resp)<br/>            throws ServletException, IOException {<br/>        Note note = new Note();<br/>        note.setDate(new Date());<br/>        note.setText(req.getParameter(&quot;note.text&quot;));<br/>        ObjectifyService.ofy().save().entities(note).now();<br/>        doGet(req, resp);<br/><br/>    }<br/><br/>}<br/>[/code]</li><br/>	<li>Create the entity to map the database<br/>[code language="java"]<br/>@Entity<br/>public class Note {<br/>    @Id<br/>    private Long id;<br/>    private Date date;<br/><br/>    public Long getId() {<br/>        return id;<br/>    }<br/><br/>    public void setId(Long id) {<br/>        this.id = id;<br/>    }<br/><br/>    private String text;<br/><br/>//rest of the getters and setters<br/>}<br/>[/code]</li><br/>	<li>Create the class with sitebrick and annotate as service. annotate the url mapping and get post methods<br/>[code language="java"]<br/>@At(&quot;/notes&quot;)<br/>@Service<br/>public class NotebookService {<br/><br/>    private Note note = new Note();<br/>    //Register the entity class for the Objectify persistance service.<br/>    public NotebookService() {<br/>        ObjectifyService.register(Note.class);<br/>    }<br/><br/>    @Get<br/>    Reply&lt;List&lt;Note&gt;&gt; showNotes() {<br/>        //Prepare the HTTP headers<br/>        Map&lt;String, String&gt; headers = new HashMap&lt;String, String&gt;();<br/>        headers.put(&quot;Content-Type&quot;, &quot;application/json&quot;);<br/>        //Fetch data from database<br/>        List&lt;Note&gt; notes = ObjectifyService.ofy().load().type(Note.class).list();<br/>        //Convert the entity object to JSON and return.<br/>        return Reply.with(notes).as(Json.class).headers(headers);<br/>    }<br/><br/>    public Note getNote() {<br/>        return note;<br/>    }<br/><br/>    public void setNote(Note note) {<br/>        this.note = note;<br/>    }<br/><br/>    /**<br/>     * Post request endpoint here inserts data in database<br/>     * and returns the JSON of the single entry which was newly<br/>     * created<br/>     *<br/>     * @param request the body of the request containing data is<br/>     *                obtained from here.<br/>     * @return<br/>     */<br/>    @Post<br/>    public Reply postNote(Request request) {<br/>        Map&lt;String, String&gt; headers = new HashMap&lt;String, String&gt;();<br/>        headers.put(&quot;Content-Type&quot;, &quot;application/json&quot;);<br/>        //Read JSON data and create entity object<br/>        note = request.read(Note.class).as(Json.class);<br/>        //System generated date instead of user<br/>        note.setDate(new Date());<br/>        //Store data<br/>        ObjectifyService.ofy().save().entities(note).now();<br/>        //Just return the newly added data<br/>        return Reply.with(note).as(Json.class).headers(headers);<br/>        /*<br/>        //to redirect to a url but this class is only for<br/>        //webservice call, we don't ahve to redirect to any page<br/>        return Reply.saying().redirect(&quot;/servlet&quot;);<br/>        */<br/>    }<br/>}<br/>[/code]</li><br/>	<li>For using sitebricks with HTML template create another class and HTML<br/>[code language="java"]<br/>@At(&quot;/webnotes&quot;)<br/>@Show(&quot;/notes.html&quot;)<br/>public class Webnote {<br/><br/>    //When HTML page is rendered , this instance variable would be used for the placeholders to populate<br/>    private List&lt;Note&gt; notes;<br/>    //Following instance variable will be populated when form is submitted from the HTML template<br/>    //The name of the input fields will be mapped to the entity components<br/>    private Note note = new Note();<br/><br/>    @Get<br/>    public void get() {<br/>        this.notes = ObjectifyService.ofy().load().type(Note.class).list();  //load from db<br/>    }<br/><br/>    public Note getNote() {<br/>        return note;<br/>    }<br/><br/>    public void setNote(Note note) {<br/>        this.note = note;<br/>    }<br/><br/>    @Post<br/>    public String post() {<br/>        //Date is not provided by the form, server date is populayted<br/>        note.setDate(new Date());<br/>        ObjectifyService.ofy().save().entities(note).now();<br/>        //Redirect to same class and render the same HTML template<br/>        return &quot;webnotes&quot;;<br/>    }<br/><br/>    public List&lt;Note&gt; getNotes() {<br/>        return notes;<br/>    }<br/><br/>    public void setNotes(List&lt;Note&gt; notes) {<br/>        this.notes = notes;<br/>    }<br/>}<br/><br/>[/code]<br/>[code language="java"]<br/>&lt;!--<br/>    HTML Template for sitebricks. This has the html form and table to enter and display the data<br/>    However theer are placeholders for sitebricks to replace the data before serving to client<br/>--&gt;<br/>&lt;html&gt;<br/>&lt;head&gt;<br/>    &lt;title&gt;&lt;/title&gt;<br/>&lt;/head&gt;<br/>&lt;body&gt;<br/>&lt;form method=post action=&quot;/webnotes&quot;&gt;<br/>    &lt;input name=note.text size=20 type=text/&gt;<br/>    &lt;input type=submit value=&quot;Add Note&quot;&gt;<br/>&lt;/form&gt;<br/>&lt;br&gt;<br/><br/>&lt;table&gt;<br/>    &lt;tr style=&quot;background:grey&quot;&gt;<br/>        &lt;th&gt;Date&lt;/th&gt;<br/>        &lt;th&gt;Note&lt;/th&gt;<br/>    &lt;/tr&gt;<br/>    @Repeat(items=notes, var=&quot;note&quot;)<br/>    &lt;tr&gt;<br/>        &lt;td&gt;${note.date}&lt;/td&gt;<br/>        &lt;td&gt;${note.text}&lt;/td&gt;<br/>    &lt;/tr&gt;<br/>&lt;/table&gt;<br/>&lt;/body&gt;<br/>&lt;/html&gt;<br/>[/code]</li><br/>	<li>Add the objectify dependencies in POM.xml<br/>[code language="xml"]<br/>  &lt;dependency&gt;<br/>          &lt;groupId&gt;com.googlecode.objectify&lt;/groupId&gt;<br/>          &lt;artifactId&gt;objectify&lt;/artifactId&gt;<br/>          &lt;version&gt;4.0b3&lt;/version&gt;<br/>      &lt;/dependency&gt;<br/>[/code]</li><br/>	<li>Register the objectify Entity class as service whenever we create any service which will have database interaction. I do it in constructor of the service class<br/>[code language="java"]<br/>    public NotebookService() {<br/>        ObjectifyService.register(Note.class);<br/>    }<br/>&lt;/li&gt;<br/>[/code]</li><br/>	<li>Read/write data using Objectify. Note.class is the entity class<br/>[code language="java"]<br/>List&lt;Note&gt; notes = ObjectifyService.ofy().load().type(Note.class).list();<br/>[/code]<br/><br/><br/>[code language="java"]<br/> ObjectifyService.ofy().save().entities(note).now();<br/>[/code]</li><br/></ol><br/>I have put all the code in Github and its still evolving, however you can get hold of the <a href="https://github.com/neilghosh/cross-note/tree/ebf9b8c154d4927f5f0efcb4b648c3effbc1f457" target="_blank">particular commit</a>.