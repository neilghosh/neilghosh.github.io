---
layout: post
title: Automatically Deploying to Google Appengine from Github using Cloud Build
date: '2019-03-19T14:56:00.001+05:30'
author: Neil Ghosh
tags:
- Google Cloud Platform
- CI/CD
- build pipeline
- Appengine
- Google Cloud Build
- Golang
modified_time: '2019-03-19T15:12:46.922+05:30'
thumbnail: https://3.bp.blogspot.com/-vJNukbPtRYA/XJCwH5_aIAI/AAAAAAACs_8/FhfD8BFIGAwX34tSJwBsYrhG3DDaDejmgCLcBGAs/s72-c/Screenshot%2B2019-03-19%2Bat%2B2.31.56%2BPM.png
blogger_id: tag:blogger.com,1999:blog-6081677503074893817.post-1502087947047823483
blogger_orig_url: https://www.neilghosh.com/2019/03/automatically-deploying-to-google.html
---

<div dir="ltr" style="text-align: left;" trbidi="on">When it comes to CI/CD pipeline, Jenkins is one of the popular tools that a lot of software companies use. With google cloud build one can build and deploy their app right from source repository like GitHub to AppEngine. It's a pay as you go service. However the first 120 build-minutes per day is free, so one can very easily try for their side projects where the deployment frequency is not more than a few times a day. However its always a good idea to limit your billing account and have alerts on usage in case it goes over the free tier due to some build stuck and running indefinitely. Here we will take an example of a go based appengine standard project.<br /><br />First, to have Cloud Build be able to deploy to appengine we need to give the service account it's going to use the roles that are required.<br /><br />Find the project id<br /><br /><pre style="background-color: #f6f8fa; border-radius: 3px; box-sizing: border-box; color: #24292e; font-family: SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; font-size: 13.6px; line-height: 1.45; margin-bottom: 16px; overflow-wrap: normal; overflow: auto; padding: 16px;"><code style="background: transparent; border-radius: 3px; border: 0px; box-sizing: border-box; display: inline; font-family: SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; font-size: 13.6px; line-height: inherit; margin: 0px; overflow-wrap: normal; overflow: visible; padding: 0px; word-break: normal;">NUM=$(gcloud projects describe $PROJECT \<br />--format="value(projectNumber)") &amp;&amp; echo ${NUM}</code></pre><br />Derive the service account name from the project id and assigned the roles<br /><br /><pre style="background-color: #f6f8fa; border-radius: 3px; box-sizing: border-box; color: #24292e; font-family: SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; font-size: 13.6px; line-height: 1.45; margin-bottom: 16px; overflow-wrap: normal; overflow: auto; padding: 16px;"><code style="background: transparent; border-radius: 3px; border: 0px; box-sizing: border-box; display: inline; font-family: SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; font-size: 13.6px; line-height: inherit; margin: 0px; overflow-wrap: normal; overflow: visible; padding: 0px; word-break: normal;">gcloud projects add-iam-policy-binding ${PROJECT} \<br />  --member=serviceAccount:${NUM}@cloudbuild.gserviceaccount.com \<br />  --role=roles/appengine.deployer<br /><br /> gcloud projects add-iam-policy-binding ${PROJECT} \<br />  --member=serviceAccount:${NUM}@cloudbuild.gserviceaccount.com \<br />  --role=roles/appengine.serviceAdmin</code></pre><div><br /></div><div>Then, we need to have a&nbsp;cloudbuild.yaml file in the root directory of the project.</div><div><br /></div><pre><code class="yaml"><br />substitutions:<br />  _APP: speechtest<br />  _BUCKET: cloud-build-speechtest<br />  _NOPROMOTE: --promote<br /><br />steps:<br />- name: 'gcr.io/cloud-builders/go'<br />  args: ['get', 'google.golang.org/appengine']<br />  env: ['GOPATH=go']<br />- name: 'gcr.io/cloud-builders/go'<br />  args: ['get', 'golang.org/x/net/context']<br />  env: ['GOPATH=go']<br />- name: 'gcr.io/cloud-builders/gcloud'<br />  args: ['app', 'deploy', '${_NOPROMOTE}' ,'go/${_APP}']<br />  env: ['GOPATH=go']<br />artifacts:<br />  objects:<br />    location: 'gs://${_BUCKET}/'<br />    paths: ['go/${_APP}/home.go']</code></pre><pre><code class="yaml">&nbsp;</code></pre><pre><code class="yaml">&nbsp;</code></pre><div>The `substitutions` can be passed from the cloud build configuration later, here we just give the default values if it's not passed.<br /><br />The directory structure of your code in GitHub should be under the GOPATH i.e. 'go/_APP/......', There are probably better ways to do it without really having to change your directory structure in GitHub just because of cloud build integration.<br /><br />Example repository -&nbsp;<a href="https://github.com/neilghosh/speechtest">https://github.com/neilghosh/speechtest</a><br /><br />In the steps, we are installing the dependencies which are outside of the GO SDK and firing "gcloud app deploy" command to deploy to app engine.<br /><br />Here our idea is to deploy to appengine every time we commit in the GitHub repository. We want to switch the traffic to 100% in the new version if it was triggered from a commit from the master branch and deploy as yet another version without making it default if it was committed in any other branch for testing purpose. Remember we can always test our app by pointing to the version-specific URL of appengine i.e.<br /><br />&nbsp; version-dot-service-dot-project.appspot.com<br /><br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="https://3.bp.blogspot.com/-vJNukbPtRYA/XJCwH5_aIAI/AAAAAAACs_8/FhfD8BFIGAwX34tSJwBsYrhG3DDaDejmgCLcBGAs/s1600/Screenshot%2B2019-03-19%2Bat%2B2.31.56%2BPM.png" style="margin-left: 1em; margin-right: 1em;"><img border="0" data-original-height="778" data-original-width="1536" height="324" src="https://3.bp.blogspot.com/-vJNukbPtRYA/XJCwH5_aIAI/AAAAAAACs_8/FhfD8BFIGAwX34tSJwBsYrhG3DDaDejmgCLcBGAs/s640/Screenshot%2B2019-03-19%2Bat%2B2.31.56%2BPM.png" width="640" /></a></div>&nbsp;To achieve this we create a trigger in the Cloud Build section of Google Cloud Platform console. We create two of them, one responds to master commits and one which responds to other branches. We need to pass a different value to the substitution '_NOPROMOTE' which will eventually decide whether to make the newly deployed version to default or not.<br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="https://3.bp.blogspot.com/-4bztwW5miUs/XJCyLa89eCI/AAAAAAACtAI/ZK2Uh7bkB3YiIgyWzfa9hD6lUcsAhQw1QCLcBGAs/s1600/Screenshot%2B2019-03-19%2Bat%2B2.33.25%2BPM.png" style="margin-left: 1em; margin-right: 1em;"><img border="0" data-original-height="1374" data-original-width="946" height="640" src="https://3.bp.blogspot.com/-4bztwW5miUs/XJCyLa89eCI/AAAAAAACtAI/ZK2Uh7bkB3YiIgyWzfa9hD6lUcsAhQw1QCLcBGAs/s640/Screenshot%2B2019-03-19%2Bat%2B2.33.25%2BPM.png" width="440" /></a></div><div class="separator" style="clear: both; text-align: center;"><br /></div><div class="separator" style="clear: both; text-align: center;"><br /></div>We can manually trigger the build as follows<br /><br /><pre style="background-color: #f6f8fa; border-radius: 3px; box-sizing: border-box; color: #24292e; font-family: SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; font-size: 13.6px; line-height: 1.45; overflow-wrap: normal; overflow: auto; padding: 16px;"><code style="background: transparent; border-radius: 3px; border: 0px; box-sizing: border-box; display: inline; font-family: SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; font-size: 13.6px; line-height: inherit; margin: 0px; overflow-wrap: normal; overflow: visible; padding: 0px; word-break: normal;">gcloud builds submit --config cloudbuild.yaml . --substitutions=_NOPROMOTE="--no-promote"<br /></code></pre><div><code style="background-attachment: initial; background-clip: initial; background-image: initial; background-origin: initial; background-position: initial; background-repeat: initial; background-size: initial; border-radius: 3px; border: 0px; box-sizing: border-box; display: inline; font-size: 13.6px; line-height: inherit; margin: 0px; overflow-wrap: normal; overflow: visible; padding: 0px; word-break: normal;"><br /></code></div>We can also test our triggers by pushing a commit to GitHub. It should trigger a build and show up in history.<br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="https://1.bp.blogspot.com/-n-NM-BG-rmQ/XJCy0jChbaI/AAAAAAACtAQ/J0noQIw2_Wgri6yCpdy8hoDLrhtcUGnAQCLcBGAs/s1600/Screenshot%2B2019-03-19%2Bat%2B2.42.16%2BPM.png" style="margin-left: 1em; margin-right: 1em;"><img border="0" data-original-height="1032" data-original-width="1600" height="412" src="https://1.bp.blogspot.com/-n-NM-BG-rmQ/XJCy0jChbaI/AAAAAAACtAQ/J0noQIw2_Wgri6yCpdy8hoDLrhtcUGnAQCLcBGAs/s640/Screenshot%2B2019-03-19%2Bat%2B2.42.16%2BPM.png" width="640" /></a></div></div><br />There is a <a href="https://github.com/marketplace/google-cloud-build" target="_blank">Google Cloud Build app </a>in GitHub market for easy integration. But as of now, there was no way to control when to trigger a build as it would just kick off a build on every commit. (without even having to create a trigger in cloud build console.)<br /><br />One can also show the build status in the GitHub Pull requests by tapping into the Pub/Sub events that cloud build automatically sends to a topic called "cloud-builds". You can use the code from the following<br /><br /><a href="https://github.com/pixiteapps/android-cloud-build/tree/master/github-status">https://github.com/pixiteapps/android-cloud-build/tree/master/github-status</a><br /><br />You just have to get a githib access token so that the cloud function code can use it to update the status in the pull requests.<br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="https://2.bp.blogspot.com/-aKVyXkJ5dMk/XJC5e6C3EtI/AAAAAAACtAc/JTIfmleZ-7odo1VzL84lx4XWxZEVFvDuwCLcBGAs/s1600/Screenshot%2B2019-03-19%2Bat%2B3.12.01%2BPM.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" data-original-height="660" data-original-width="1594" height="264" src="https://2.bp.blogspot.com/-aKVyXkJ5dMk/XJC5e6C3EtI/AAAAAAACtAc/JTIfmleZ-7odo1VzL84lx4XWxZEVFvDuwCLcBGAs/s640/Screenshot%2B2019-03-19%2Bat%2B3.12.01%2BPM.png" width="640" /></a></div><br /><br /><br /><br /></div>