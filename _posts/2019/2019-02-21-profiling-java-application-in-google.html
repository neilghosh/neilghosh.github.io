---
layout: post
title: Profiling Java application in Google Appengine Flex
date: '2019-02-21T15:04:00.000+05:30'
author: Neil Ghosh
tags:
- google cloud
- Appengine
- appengine flex
- memory
- GCP
- heap dump
- profiling
modified_time: '2019-02-25T15:10:32.716+05:30'
thumbnail: https://1.bp.blogspot.com/-g9BVd6fa50U/XHOxfT9QiEI/AAAAAAACrtc/ApiSRd0G244q6qggSdz3JndCvpLvjGJTwCLcBGAs/s72-c/Screenshot%2B2019-02-25%2Bat%2B2.42.09%2BPM.png
blogger_id: tag:blogger.com,1999:blog-6081677503074893817.post-2870097327104815631
blogger_orig_url: https://www.neilghosh.com/2019/02/profiling-java-application-in-google.html
---

<div dir="ltr" style="text-align: left;" trbidi="on">There are a lot of ways java applications can be profiled for memory and CPU to find memory leaks or any culprit block of code where the app spends most of the time. In Google AppEngine Flex the application code (jar or war) runs inside a docker container which in turn runs inside a VM dedicated a service/module. While Google Cloud Profile can be used for analysing live applications it only supports CPU profiling when it comes to Java in AppEngine flex. Memory profiling is supported for Java only in AppEngine standard and python and go in AppEngine flex. So as of now, one has to profile the memory in JVM manually.<br /><h4 style="text-align: left;">SSH to the AppEngine instance</h4><div style="text-align: left;">If you have Editor role you can ssh to the specific appengine flex instance using gcloud utility. You can <a href="https://cloud.google.com/appengine/docs/flexible/python/debugging-an-instance">connect to the instance</a> by clicking on the SSH button against the instance in the instances page in the appengine GCP console.<br /><ol style="text-align: left;"><li>&nbsp;SSH to the instance <br />        <pre><code class="bash"><br />$ gcloud --project "demoneil" app instances ssh "aef-default-20190225t133842-tlmz" --service "default" --version "20190225t133842"</code></pre></li><li>Find the docker processes.<br /><br /> <pre><code class="bash"><br />$ docker ps<br />        CONTAINER ID        IMAGE                                                                                                                            CONTAINER ID        IMAGE                                                                                                                            COMMAND                  CREATED             STATUS              PORTS                                                                  NAMES<br />d388874ebe58        asia.gcr.io/demoneil/appengine/default.20190225t133842@sha256:cad540ad23c872496cfc73721a096f27481b6360a7cfb7867796e627f6f2c25e   "/docker-entrypoin..."   41 minutes ago      Up 41 minutes       172.17.0.1:8080-&gt;8080/tcp                                              gaeapp<br />f01675bb33c8        gcr.io/google-appengine/api-proxy                                                                                                "/proxy"                 41 minutes ago      Up 41 minutes                                                                              api<br />8ef572057a10        gcr.io/google-appengine/nginx-proxy                                                                                              "/var/lib/nginx/bi..."   42 minutes ago      Up 42 minutes       8080/tcp, 0.0.0.0:8443-&gt;8443/tcp, 8090/tcp, 0.0.0.0:10402-&gt;10402/tcp   nginx_proxy<br />69fce23569a2        gcr.io/google-appengine/iap-watcher                                                                                              "./start_iap_watch..."   42 minutes ago      Up 42 minutes                                                                              iap_watcher<br />aca67e06d5ed        gcr.io/google-appengine/fluentd-logger                                                                                           "/opt/google-fluen..."   42 minutes ago      Up 42 minutes                                                                              fluentd_logger<br /></code><br /></pre></li><li>Get a shell for the docker container running your code. Usually, it has an image URL from grc.io and name as "gaeapp", like the first one here.<pre><code class="bash">$ docker exec -it gaeapp /bin/bash<br /><br /></code></pre></li><li>Find the process and change the user to the user running the jetty server, which is usually "jetty"<br /><pre><code class="bash"><br />root@d388874ebe58:/var/lib/jetty# ps -aux<br /><br />USER       PID %CPU %MEM    VSZ   RSS TTY      STAT START   TIME COMMAND<br />jetty        1  0.1 11.0 2509224 113236 ?      Ssl  08:13   0:05 java -showversion -Djava.io.tmpdir=/tmp/jetty -agentpath:/opt/cdbg/cdbg_java_agent.so=--log_dir=/var/log/app_engine,--alsologtostderr=tru<br />root       187  0.0  0.3  18140  3268 ?        Ss   09:01   0:00 /bin/bash<br />root       191  0.0  0.2  36636  2816 ?        R+   09:02   0:00 ps -aux<br /><br><br />$ su jetty  <br /></code></pre></li><li>Create a directory to write the heap dump as the current directory may not have write access.<br />        <pre><code class="bash"><br />mkdir dump_dir.<br />chmod 777 dump_dir</code></pre> </li><li>Generate the heap dump for the process id<br />        <pre><code class="bash"><br />jmap -dump:live,file=dump_dir/ 50<br /><br /></code></pre></li><li>Exit the container and copy the dump file from within the container to the VM<br />        <pre><code class="bash"><br />docker cp gaeapp:/var/lib/jetty/dump_dir/mem.prof .<br /><br /></code></pre></li><li>Exit the VM and copy the file from the VM to the local machine<br />        <pre><code class="bash"><br />gcloud app instances scp --service default --version 20190225t133842 aef-default-20190225t133842-tlmz:/home/neil/mem.prof .<br /></code></pre></li></ol></div><br /><div style="text-align: left;"><b>Analyse the dump</b><br /><br />There are several tools like <a href="https://visualvm.github.io/">VisualVM</a> and Yorkit to analyse the heap dump file to find out where are the memory issues. I used something <a href="http://heaphero.io/">heaphero.io</a> which is publicly hosted and good for small dump files.</div><div style="text-align: left;"><br /><div class="separator" style="clear: both; text-align: center;"><a href="https://1.bp.blogspot.com/-g9BVd6fa50U/XHOxfT9QiEI/AAAAAAACrtc/ApiSRd0G244q6qggSdz3JndCvpLvjGJTwCLcBGAs/s1600/Screenshot%2B2019-02-25%2Bat%2B2.42.09%2BPM.png" style="margin-left: 1em; margin-right: 1em;"><img border="0" data-original-height="952" data-original-width="1192" height="510" src="https://1.bp.blogspot.com/-g9BVd6fa50U/XHOxfT9QiEI/AAAAAAACrtc/ApiSRd0G244q6qggSdz3JndCvpLvjGJTwCLcBGAs/s640/Screenshot%2B2019-02-25%2Bat%2B2.42.09%2BPM.png" width="640" /></a></div>Here is a <a href="https://heaphero.io/my-heap-report.jsp?p=YXJjaGl2ZWQvMjAxOS8wMi8yNS8tLW1lbS5wcm9mLTgtNTAtNTUuanNvbi0t">sample report</a> for the getting started the app.<br /><br /></div><div style="text-align: left;"><br /></div></div>