---
layout: post
title: Downloading And Storing Financial Data With Google Cloud Scheduler, Cloud Storage
  and BigQuery
date: '2019-08-18T22:53:00.000+05:30'
author: Neil Ghosh
tags:
- Google Cloud Platform
- Historical Price
- Stock Market
- Cloud Functions
- bigquery
- Cloud Storage
- Cloud Scheduler
- GCP
- Financial Data
modified_time: '2019-08-18T22:53:37.174+05:30'
thumbnail: https://1.bp.blogspot.com/-YkbU0C1EXDk/XVmAfPjNRLI/AAAAAAAC6Nk/wJM_HFyoTh4kXBgHyVnx8zkFW2FtiQ1qQCLcBGAs/s72-c/Screenshot%2B2019-08-18%2Bat%2B10.14.32%2BPM.png
blogger_id: tag:blogger.com,1999:blog-6081677503074893817.post-6077274643926328706
blogger_orig_url: https://www.neilghosh.com/2019/08/downloading-and-storing-financial-data.html
---

<div dir="ltr" style="text-align: left;" trbidi="on">Financial data from the stock market usually are available through APIs like <a href="https://www.bloomberg.com/professional/support/api-library/" target="_blank">Bloomberg API</a>. Almost 12 years ago I worked for a company where they needed download and store historical data with the C SDK and also run a periodic cronjob to execute the same every day for that day's data (e.g. Day high, close, low, open prices and volumes). This was mostly run aftermarket when it was supposed to be available for that day. Ultimately data was stored in PostgreSQL and cater to many applications like Option Simulation (predicting the premium in upcoming days before option expiry using the volatility calculated by <a href="https://www.investopedia.com/terms/b/blackscholes.asp" target="_blank"><span class="ILfuVd"><span class="e24Kjd">Black Scholes model</span></span></a> ) and plotting bar charts (.NET or Adobe Flex desktop charts). The Simulation software was all written in PHP (in an object-oriented way) and some business users also used connectors from Microsoft Exel to fetch data from PostgreSQL directly.<br /><br />While all these financial features were ahead of time, had all these done been done now, the obvious choice was probably to do everything in close and make it accessible to users (maybe earn from subscription). I remember, because we did not have a static IP, some internal users accessed the tools and charts via GoToMyPC :).<br /><br /><b>Google Cloud Scheduler</b> lets you trigger a specific endpoint at a specific interval. Following configuration runs an HTTP calls the GET endpoint everyday at midnight.<br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="https://1.bp.blogspot.com/-YkbU0C1EXDk/XVmAfPjNRLI/AAAAAAAC6Nk/wJM_HFyoTh4kXBgHyVnx8zkFW2FtiQ1qQCLcBGAs/s1600/Screenshot%2B2019-08-18%2Bat%2B10.14.32%2BPM.png" style="margin-left: 1em; margin-right: 1em;"><img border="0" data-original-height="1090" data-original-width="950" height="640" src="https://1.bp.blogspot.com/-YkbU0C1EXDk/XVmAfPjNRLI/AAAAAAAC6Nk/wJM_HFyoTh4kXBgHyVnx8zkFW2FtiQ1qQCLcBGAs/s640/Screenshot%2B2019-08-18%2Bat%2B10.14.32%2BPM.png" width="556" /></a></div>The above endpoint comes from a <b>Google Cloud Function</b> written in NodeJS which pulls a zip file from the <a href="https://www.nseindia.com/products/content/equities/equities/equities.htm" target="_blank">National Stock Exchange</a> and saves in a bucket in Google Cloud Storage. As of now, Cloud Function supports <a href="https://cloud.google.com/functions/docs/writing/" target="_blank">NodeJS as GA</a> and NodeJS also have a very easy to use <a href="https://www.npmjs.com/package/@google-cloud/storage" target="_blank">Client SDK</a> to interact with Cloud Storage.<br /><br />Following the code, a snippet to write raw data to Google Cloud Storage<br /><br /><div style="background: #ffffff; border-width: 0.1em 0.1em 0.1em 0.8em; border: solid gray; overflow: auto; padding: 0.2em 0.6em; width: auto;"><pre style="line-height: 125%; margin: 0;">async <span style="color: #008800; font-weight: bold;">function</span> writeToBucket(date, data) {<br />  <span style="color: #008800; font-weight: bold;">var</span> fileName <span style="color: #333333;">=</span> date.toISOString().split(<span style="background-color: #fff0f0;">'T'</span>)[<span style="color: #0000dd; font-weight: bold;">0</span>] <span style="color: #333333;">+</span> <span style="background-color: #fff0f0;">'.csv'</span>;<br />  console.log(<span style="background-color: #fff0f0;">"Saving in GCS as "</span> <span style="color: #333333;">+</span> fileName);<br />  <span style="color: #008800; font-weight: bold;">var</span> file <span style="color: #333333;">=</span> gcsBucket.file(fileName);<br /><br />  file.createWriteStream({<br />    metadata<span style="color: #333333;">:</span> {<br />      contentType<span style="color: #333333;">:</span> <span style="background-color: #fff0f0;">'text/csv'</span>,<br />      metadata<span style="color: #333333;">:</span> {<br />        custom<span style="color: #333333;">:</span> <span style="background-color: #fff0f0;">'metadata'</span><br />      }<br />    }<br />  })<br />    .on(<span style="background-color: #fff0f0;">'error'</span>, <span style="color: #008800; font-weight: bold;">function</span> (err) { })<br />    .on(<span style="background-color: #fff0f0;">'finish'</span>, <span style="color: #008800; font-weight: bold;">function</span> () { console.log(<span style="background-color: #fff0f0;">"Uploaded"</span>); })<br />    .end(data);<br />}<br /></pre></div><br /><a href="https://github.com/neilghosh/nse-historical-data/tree/master/functions/getQuotesByDate" target="_blank">Full Code.</a><br /><br />So now, every day as the new data is available in the market, new files would be created in the bucket.<br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="https://1.bp.blogspot.com/-FiO9QxWwLxY/XVmDgChcW6I/AAAAAAAC6Nw/7D5dq7ZC82EH6qDwhZ712sbCVlWhUFYHgCLcBGAs/s1600/Screenshot%2B2019-08-18%2Bat%2B10.27.13%2BPM.png" style="margin-left: 1em; margin-right: 1em;"><img border="0" data-original-height="670" data-original-width="1334" height="321" src="https://1.bp.blogspot.com/-FiO9QxWwLxY/XVmDgChcW6I/AAAAAAAC6Nw/7D5dq7ZC82EH6qDwhZ712sbCVlWhUFYHgCLcBGAs/s640/Screenshot%2B2019-08-18%2Bat%2B10.27.13%2BPM.png" width="640" /></a></div><br />Data in Cloud Storage is not queriable very easily. Hence this needs to go to a database system. Google BigQuery is a natural choice if you want to run some ad-hock query and analysis, especially when the volume of data grows a lot i.e. years of stock data.<br /><br />Google Cloud Storage lets you trigger a cloud function automatically when a file is created (or changed) in a bucket. Using this feature we could invoke another cloud function which can keep appending data to Bigquery as and when data arrives in the Google Cloud Storage in the form of a new file. We would basically write another snipper of NodeJS code which would load a the newly arrived CSV file to the existing bigquery table periodically. In this way we do not have to schedule another cron job and co-ordinate the schedule, the two events (downloading data and loading to Bigquery) would basically chain one after another.<br /><br /><br /><div style="background: #ffffff; border-width: 0.1em 0.1em 0.1em 0.8em; border: solid gray; overflow: auto; padding: 0.2em 0.6em; width: auto;"><table><tbody><tr><td><pre style="line-height: 125%; margin: 0;"> 1<br /> 2<br /> 3<br /> 4<br /> 5<br /> 6<br /> 7<br /> 8<br /> 9<br />10<br />11<br />12<br />13<br />14<br />15<br />16</pre></td><td><pre style="line-height: 125%; margin: 0;">    <span style="color: #888888;">// https://cloud.google.com/bigquery/docs/reference/rest/v2/Job#JobConfigurationLoad</span><br />    <span style="color: #008800; font-weight: bold;">const</span> metadata <span style="color: #333333;">=</span> {<br />      sourceFormat<span style="color: #333333;">:</span> <span style="background-color: #fff0f0;">'CSV'</span>,<br />      skipLeadingRows<span style="color: #333333;">:</span> <span style="color: #0000dd; font-weight: bold;">1</span>,<br />      autodetect<span style="color: #333333;">:</span> <span style="color: #008800; font-weight: bold;">true</span>,<br />      location<span style="color: #333333;">:</span> <span style="background-color: #fff0f0;">'US'</span>,<br />    };<br /><br />    <span style="color: #888888;">// Load data from a Google Cloud Storage file into the table</span><br />    <span style="color: #008800; font-weight: bold;">const</span> [job] <span style="color: #333333;">=</span> await bigquery<br />      .dataset(datasetId)<br />      .table(tableId)<br />      .load(storage.bucket(bucketName).file(filename), metadata);<br /><br />    <span style="color: #888888;">// load() waits for the job to finish</span><br />    console.log(<span style="background-color: #ffaaaa; color: red;">`</span>Job ${job.id} completed.<span style="background-color: #ffaaaa; color: red;">`</span>);<br /></pre></td></tr></tbody></table></div><br /><a href="https://github.com/neilghosh/nse-historical-data/tree/master/functions/loadQuotesToBQ">Full Code.</a><br /><br />Note that <a href="https://cloud.google.com/bigquery/docs/reference/standard-sql/data-manipulation-language">DML is expensive</a> in BigQuery but data can be loaded multiple times to append into the table. This is a synchronous job so we could very well choose not to wait for the job to be completed. However, for data integrity, we wanted to wait in case there is any failure. Also since the size of the daily data is predictable we can pretty much say that it will complete before the function times out.<br />&nbsp; <br /><div class="separator" style="clear: both; text-align: center;"><a href="https://1.bp.blogspot.com/-J_cfUOGfpuQ/XVmG1hI05CI/AAAAAAAC6N8/DMnp6UWpuxsd1D8VVpyddj-gF3t2B94GgCLcBGAs/s1600/Screenshot%2B2019-08-18%2Bat%2B10.41.40%2BPM.png" style="margin-left: 1em; margin-right: 1em;"><img border="0" data-original-height="508" data-original-width="1600" height="202" src="https://1.bp.blogspot.com/-J_cfUOGfpuQ/XVmG1hI05CI/AAAAAAAC6N8/DMnp6UWpuxsd1D8VVpyddj-gF3t2B94GgCLcBGAs/s640/Screenshot%2B2019-08-18%2Bat%2B10.41.40%2BPM.png" width="640" /></a></div><br />Now that we have the data in Bigquery we could run any ad hoc queries to analyse them. <a href="https://datastudio.google.com/">Google Data Studio</a> is a great tool for the same. You can plot charts or filter by various condition to analyse time-series data like historical prices.<br /><br />If you want this data to be used by any live application like portfolio management system or charting application, may be these data can be stored in an RDBMS like CloudSQL.<br /><br />The above code downloads data from NSE which is only for demo/tutorial purpose. Commercial use of that might be prohibited.<br /><br />The code is originally hosted at the GitHub Repo <a href="https://github.com/neilghosh/nse-historical-data">nse-historical-data</a>. However the cloud functions deployed are using the code from a <a href="https://cloud.google.com/source-repositories/">https://cloud.google.com/source-repositories/</a>Cloud Source Repository which in turns mirrors the above GitHub repository.<br /><br /><br /><br /></div>