---
layout: post
title: Deploying apps in Google Cloud Platform using GitHub Actions.
date: '2019-09-02T21:50:00.000+05:30'
author: Neil Ghosh
tags:
- Google Cloud Platform
- CI/CD
- actions
- workflows
- GCP
- github
- Google Cloud Functions
modified_time: '2019-09-03T13:26:23.839+05:30'
thumbnail: https://1.bp.blogspot.com/-0w8IBtg7DnA/XW4cndrA7TI/AAAAAAAC7ZA/GOMJNjvLdlgmGZJdTAToB2sQ6dDLsrOjACLcBGAs/s72-c/action_gcp.png
blogger_id: tag:blogger.com,1999:blog-6081677503074893817.post-4496607842077363254
blogger_orig_url: https://www.neilghosh.com/2019/09/deploying-apps-in-google-cloud-platform.html
---

<div dir="ltr" style="text-align: left;" trbidi="on"><br /><div class="separator" style="clear: both; text-align: center;"><a href="https://1.bp.blogspot.com/-0w8IBtg7DnA/XW4cndrA7TI/AAAAAAAC7ZA/GOMJNjvLdlgmGZJdTAToB2sQ6dDLsrOjACLcBGAs/s1600/action_gcp.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" data-original-height="192" data-original-width="400" height="153" src="https://1.bp.blogspot.com/-0w8IBtg7DnA/XW4cndrA7TI/AAAAAAAC7ZA/GOMJNjvLdlgmGZJdTAToB2sQ6dDLsrOjACLcBGAs/s320/action_gcp.png" width="320" /></a></div><br />After GitHub announced <a href="https://github.blog/2018-10-17-action-demos/" target="_blank">action</a> last year, they recently announced that it would <a href="https://github.blog/2019-08-08-github-actions-now-supports-ci-cd/" target="_blank">support CI/CD</a> free for the public repository as well. This is exciting because earlier most of the public repos were leveraging 3rd party <a href="https://github.com/marketplace/travis-ci" target="_blank">Travis CI</a>.&nbsp; Travis CI is really simple for straight forward use cases, sometimes just <a href="https://github.com/neilghosh/mypubsub/blob/master/.travis.yml" target="_blank">one line.</a> And also free for open source projects (Public repos on GitHub)<br /><br />I had signed up for GitHub <a href="https://github.com/features/actions" target="_blank">action beta program</a> earlier and recently got the invite. After signing up you can see the new "Actions" tab in the top of all of your repositories<br /><br /><table align="center" cellpadding="0" cellspacing="0" class="tr-caption-container" style="margin-left: auto; margin-right: auto; text-align: center;"><tbody><tr><td style="text-align: center;"><a href="https://1.bp.blogspot.com/-IbD2SsjYgjY/XW0uQ3uM7oI/AAAAAAAC7U0/5rFKJspv4NkQ62vhpQgX36r0CJMeY6cHwCLcBGAs/s1600/Screenshot%2B2019-09-02%2Bat%2B8.15.18%2BPM.png" style="margin-left: auto; margin-right: auto;"><img border="0" data-original-height="239" data-original-width="1098" height="138" src="https://1.bp.blogspot.com/-IbD2SsjYgjY/XW0uQ3uM7oI/AAAAAAAC7U0/5rFKJspv4NkQ62vhpQgX36r0CJMeY6cHwCLcBGAs/s640/Screenshot%2B2019-09-02%2Bat%2B8.15.18%2BPM.png" width="640" /></a></td></tr><tr><td class="tr-caption" style="text-align: center;">The new Actions Tab</td><td class="tr-caption" style="text-align: center;"><br /></td><td class="tr-caption" style="text-align: center;"><br /></td></tr></tbody></table>Earlier I <a href="https://www.neilghosh.com/2019/03/automatically-deploying-to-google.html" target="_blank">blogged</a> about how to deploy to google cloud from GitHub repository using Google Cloud Build. Here I wanted to use GitHub Actions instead to directly deploying a cloud function.<br /><br /><ul style="text-align: left;"><li>To get started one needs to have a <i>.github/workflows </i>directory at the root of the repo.</li><li>Under the above directory, one can have multiple <a href="https://github.com/neilghosh/nse-historical-data/blob/master/.github/workflows/deploy-function.yml" target="_blank">.yaml</a> files to configure multiple workflows which can be run independently.</li><li>The important sections of the action YAML are as follows</li><ul><li>Tell when the action needs to execute. Here I want it to trigger every time I commit to master in a specific directory<br /><pre><code><br />on: <br />  push:<br />    branches:<br />      - master<br />    paths:<br />      - 'functions/getQuotesByDate/*'</code></pre><pre><code>&nbsp;</code></pre></li><li>Now define the build steps <pre><code><br /> steps:<br />    - uses: actions/checkout@v1<br />    - name: Install gcloud SDK<br />      run: |<br />        sudo apt-get update &amp;&amp; sudo apt-get install google-cloud-sdk<br />    - name: Activate Service Account <br />      env: <br />        GCLOUD_AUTH: ${{ "{{" }} secrets.GCLOUD_AUTH }}<br />      run: |<br />        echo "$GCLOUD_AUTH" | base64 --decode &gt; "$HOME"/gcloud.json<br />        sh -c "gcloud auth activate-service-account --key-file=$HOME/gcloud.json $*"<br />    - name: deploy function <br />      run: |<br />        gcloud functions deploy getQuotesByDate --runtime nodejs8 --project demoneil --service-account github-actions@demoneil.iam.gserviceaccount.com --source functions/getQuotesByDate<br /><br /></code></pre></li></ul><li>Since you are deploying automatically from a CI/CD system you would need a Service Account of your GCP project which has enough permission to deploy a function. You can create a service account and key as follows.</li><ul><li>&nbsp;In GCP console go to <a href="https://console.cloud.google.com/iam-admin/serviceaccounts" target="_blank">IAM &amp; Admin --&gt; Service Accounts</a>.&nbsp;</li><li>Select your GCP project from the top list</li><li>Provide a conspicuous name, Id and description&nbsp;</li><li>Provide enough permission to deploy a cloud function. An editor will work but in a real scenario, you may want to restrict it to further less e.g. GCF admin or equivalent.</li><li>Create a key for your Service Account.<br /> <div class="separator" style="clear: both; text-align: center;"><a href="https://1.bp.blogspot.com/-10Nnrf0-Ld0/XW08nuT38GI/AAAAAAAC7VE/t8Kau9SYengSPAtHV1K_FhTy8T1AhvbUQCLcBGAs/s1600/Screenshot%2B2019-09-02%2Bat%2B9.30.06%2BPM.png" style="margin-left: 1em; margin-right: 1em;"><img border="0" data-original-height="682" data-original-width="1098" height="396" src="https://1.bp.blogspot.com/-10Nnrf0-Ld0/XW08nuT38GI/AAAAAAAC7VE/t8Kau9SYengSPAtHV1K_FhTy8T1AhvbUQCLcBGAs/s640/Screenshot%2B2019-09-02%2Bat%2B9.30.06%2BPM.png" width="640" /></a></div></li>Convert the key to base64 string. For example, in bash, you can run the following <pre><code><br />$base64 ~/Desktop/demoneil-26fabe6f9020.json<br /><br /></code></pre><li>Since we can't really check in the key in the repo we have somehow hide it from the users. Take the above base64 string and create a GitHub secret in the Repository Settings<div class="separator" style="clear: both; text-align: center;"><a href="https://1.bp.blogspot.com/-lRxrZ276ToQ/XW09cXFnOLI/AAAAAAAC7VM/JAEUyk99ZG0_bgUA2WcglgGVaAIoWzo4wCLcBGAs/s1600/Screenshot%2B2019-09-02%2Bat%2B9.33.48%2BPM.png" style="margin-left: 1em; margin-right: 1em;"><img border="0" data-original-height="594" data-original-width="1600" height="235" src="https://1.bp.blogspot.com/-lRxrZ276ToQ/XW09cXFnOLI/AAAAAAAC7VM/JAEUyk99ZG0_bgUA2WcglgGVaAIoWzo4wCLcBGAs/s640/Screenshot%2B2019-09-02%2Bat%2B9.33.48%2BPM.png" width="640" /></a></div><br />GitHub Actions allow you to access this secret from work flow defination file.<br />e.g. <i>${{ "{{" }} secrets.GCLOUD_AUTH }}</i> <br /><br />Note that in the YAML file we have written command to decode the secret string back to JSON and store it in the local VM where the action is running.&nbsp;</li></ul></ul>While the above method is good for demonstration, installing the Google Cloud SDK in the VM is an expensive operation which can display your deployment from the time you check-in code. To make it faster one can just use the docker container containing the SDK. <a href="https://developer.github.com/actions/creating-github-actions/creating-a-docker-container/">More on this.</a><br /><br />Also, ideally this whole authentication process and command line (to deploy) should be a pre-defined action like <a href="https://github.com/actions/gcloud">this</a>, either in the repo itself or at a central repository. Actions are re-usable, instead of everyone is trying to run the same set of command in the YAML file.<br /><br />I will probably write a follow-up post after creating a re-usable action. This is just a small example, similarly, any deployment in GCP can be done by authenticating and adding appropriate gcloud command like above.<br /><ul style="text-align: left;"><ul> </ul><ul>&nbsp;</ul></ul></div>